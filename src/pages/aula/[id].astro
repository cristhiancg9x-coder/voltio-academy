---
// src/pages/aula/[id].astro
import BaseLayout from '../../layouts/BaseLayout.astro';
import VideoPlayer from '../../components/ui/VideoPlayer.jsx';
import { coursesContent } from '../../data/coursesContent.js';

// --- SEGURIDAD: VERIFICACIÓN DE COMPRA ---
import { supabase } from '../../lib/supabase'; // Asegúrate de tener este cliente disponible o usar fetch

const { id } = Astro.params;
const curso = coursesContent[id];

// 1. Si el curso no existe en nuestra data, 404
if (!curso) {
  return Astro.redirect('/404');
}

// 2. Lógica de Protección (Server Side)
// Astro se ejecuta en el servidor antes de enviar la página.
// Verificamos cookies de sesión o redirigimos a login si no hay token.
// NOTA: Para protección total en Astro SSR (Server Side Rendering), necesitamos adaptadores.
// Como estamos en modo estático/híbrido, haremos la protección en el CLIENTE (abajo en el script).
---

<BaseLayout title={`Aula: ${curso.title}`} description="Zona de estudio">
  
  {/* Capa de protección visual mientras verificamos */}
  <div id="classroom-guard" class="fixed inset-0 bg-volt-dark z-50 flex flex-col items-center justify-center">
      <div class="w-12 h-12 border-4 border-volt-primary border-t-transparent rounded-full animate-spin mb-4"></div>
      <p class="text-slate-400">Verificando tu matrícula...</p>
  </div>

  <div id="classroom-content" class="hidden min-h-screen bg-[#0a0a0a]">
    <VideoPlayer client:only="react" courseData={curso} />
  </div>

</BaseLayout>

<script define:vars={{ courseId: id }}>
    // ESTE ES EL GUARDIA DE SEGURIDAD
    import { supabase } from '../../lib/supabase'; // Asegúrate de que la ruta sea correcta

    async function protectRoute() {
        const { data: { user } } = await supabase.auth.getUser();

        if (!user) {
            window.location.href = '/login'; // No logueado -> Fuera
            return;
        }

        // Si es un curso GRATIS, lo dejamos pasar (según tu lógica)
        // Pero si es DE PAGO, consultamos a la API si lo compró
        const API_URL = "https://api-voltio.onrender.com"; // O tu localhost
        
        try {
            const response = await fetch(`${API_URL}/api/mis-cursos/${user.email}`);
            const misCursos = await response.json();

            // Lógica: Si el ID del curso está en la lista de comprados O es un curso gratis
            // (Aquí asumo que 'domiciliaria-1' y 'planos-1' son gratis siempre)
            const cursosGratis = ['domiciliaria-1', 'planos-1'];
            
            if (misCursos.includes(courseId) || cursosGratis.includes(courseId)) {
                // ACCESO CONCEDIDO
                document.getElementById('classroom-guard').style.display = 'none';
                document.getElementById('classroom-content').classList.remove('hidden');
            } else {
                // ACCESO DENEGADO
                alert("⛔ Acceso denegado: No has comprado este curso.");
                window.location.href = '/cursos';
            }
        } catch (e) {
            console.error(e);
            window.location.href = '/cursos';
        }
    }

    protectRoute();
</script>